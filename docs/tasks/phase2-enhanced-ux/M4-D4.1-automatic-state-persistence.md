# [M4-D4.1] Implement automatic state persistence with localStorage

## Deliverable: State auto-saves to localStorage and restores on page reload

### Context
**PRD:** `docs/project/PRD/active/PRD-phase2-enhanced-ux.md` — M4: Auto-Save with localStorage, D4.1

Users currently lose all work if they forget to manually save before closing the browser. This deliverable implements automatic state persistence using localStorage, ensuring work survives page reloads and accidental closures.

### Traceability
- **PRD Section:** M4-D4.1 "Automatic state persistence"
- **Functional Requirement:** Save to localStorage on every state change, debounced 500ms
- **Success Criteria:** SC-4 "State persists across page reloads"

### Acceptance Criteria
- [ ] State saved to localStorage key `kanban-vibe-autosave`
- [ ] Save debounced: waits 500ms after last change before saving
- [ ] Saves on: card changes, day advancement, WIP limit changes, worker changes
- [ ] On page load, state restored from localStorage if available
- [ ] If no saved state, application starts with default empty state
- [ ] Corrupted localStorage data handled gracefully (fallback to empty state)
- [ ] State includes: currentDay, cards, workers, wipLimits, historicalData

### Edge Case Scenarios
- Rapid state changes (10 in 100ms) → Only one save after 500ms debounce
- localStorage full (quota exceeded) → Error logged, user notified via toast, app continues
- localStorage contains invalid JSON → Fallback to empty state, log warning
- localStorage disabled (private mode) → App works without persistence, log warning
- Page closed during debounce wait → State not saved (acceptable trade-off)
- Browser crash → Last debounced save restored

### Implementation Guidelines
- Create `src/hooks/useLocalStorageSync.ts` custom hook
- Use `useEffect` with debounced save triggered by state dependencies
- Debounce implementation: setTimeout with cleanup on dependency change
```typescript
const STORAGE_KEY = 'kanban-vibe-autosave';
const DEBOUNCE_MS = 500;

function useLocalStorageSync(state: KanbanState) {
  useEffect(() => {
    const timeoutId = setTimeout(() => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('Failed to save state:', e);
        // Show toast notification for quota exceeded
      }
    }, DEBOUNCE_MS);

    return () => clearTimeout(timeoutId);
  }, [state]);
}
```
- Create initialization function to load state on mount
- Match localStorage schema from PRD Section 7:
```typescript
interface LocalStorageSchema {
  'kanban-vibe-autosave': KanbanState;
}
```
- Handle QuotaExceededError specifically for storage full scenario

### Embedded Reasoning
**Why:** "Invisible persistence" is a Phase 2 design principle—users shouldn't have to think about saving.
**What:** Automatic save to localStorage on every state change with debouncing to avoid performance issues.
**How:** Custom hook with useEffect and setTimeout for debouncing, try/catch for error handling.

### Testing Strategy
- **Unit:** Test state serializes to localStorage after debounce
- **Unit:** Test rapid changes result in single save
- **Unit:** Test state loads from localStorage on mount
- **Unit:** Test invalid JSON fallback to empty state
- **Unit:** Test QuotaExceededError handling
- **Integration:** Test full save/reload cycle preserves state
- **Edge Cases:** Test localStorage disabled, test corrupted data

### Dependencies
None - this is foundational for M4-D4.2 (Auto-save indicator)

### Verification
1. Add cards, advance days → State in localStorage (check DevTools > Application > Local Storage)
2. Reload page → Cards and day counter restored
3. Clear localStorage, reload → Empty state (no error)
4. Corrupt localStorage JSON manually, reload → Empty state with console warning
5. Run `npm test` → All localStorage tests pass
