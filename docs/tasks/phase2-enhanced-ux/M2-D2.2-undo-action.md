# [M2-D2.2] Implement undo action with keyboard shortcut

## Deliverable: Users can undo the last significant action via Ctrl+Z or toolbar button

### Context
**PRD:** `docs/project/PRD/active/PRD-phase2-enhanced-ux.md` — M2: Undo/Redo System, D2.2

With the history manager in place, users need a way to trigger undo. This deliverable adds keyboard shortcut (Ctrl+Z / Cmd+Z) and toolbar button to restore the previous state from history.

### Traceability
- **PRD Section:** M2-D2.2 "Undo action"
- **Functional Requirement:** Keyboard shortcut Ctrl+Z/Cmd+Z, toolbar button, restores previous state
- **Success Criteria:** SC-2 "Undo reverts last significant action"

### Acceptance Criteria
- [ ] Ctrl+Z (Windows/Linux) triggers undo
- [ ] Cmd+Z (macOS) triggers undo
- [ ] Undo button appears in navigation bar
- [ ] Undo button disabled when canUndo() is false
- [ ] Undo restores previous state from history
- [ ] Undo works for: card creation, card movement, worker assignment, day advancement, WIP changes
- [ ] Multiple consecutive undos move further back in history

### Edge Case Scenarios
- Press Ctrl+Z with no history → No action, button remains disabled
- Press Ctrl+Z at beginning of history → No action, state unchanged
- Press Ctrl+Z during policy execution → Policy cancelled, then undo applied
- Press Ctrl+Z while input field focused → Standard browser undo in input, not app undo
- Undo day advancement → Day counter, card ages, and positions all restored

### Implementation Guidelines
- Add keyboard event listener in `src/App.tsx` using `useEffect`
- Detect platform for Cmd vs Ctrl: `e.metaKey` (Mac) or `e.ctrlKey` (Windows/Linux)
- Prevent default browser behavior with `e.preventDefault()`
- Check `e.target` to skip when focused on input/textarea elements
- Add undo button to `src/components/NavigationBar.tsx` near save/import actions
- Use SVG icon for undo (counterclockwise arrow)
- Integrate with history manager from M2-D2.1: call `historyManager.undo()`
- Apply returned state to all app state setters (setCards, setCurrentDay, setWipLimits, etc.)

### Embedded Reasoning
**Why:** Keyboard shortcuts are the fastest way to undo mistakes; toolbar button provides discoverability and accessibility.
**What:** Undo functionality triggered by Ctrl+Z or clicking undo button, restoring previous state snapshot.
**How:** Global keyboard listener + button in nav bar, both calling history manager's undo method and applying returned state.

### Testing Strategy
- **Unit:** Test keyboard event listener responds to Ctrl+Z
- **Unit:** Test keyboard event listener responds to Cmd+Z (metaKey)
- **Unit:** Test undo button disabled state matches canUndo()
- **Unit:** Test undo button click calls undo function
- **Integration:** Test undo restores cards to previous positions
- **Integration:** Test undo restores day counter
- **Edge Cases:** Test no-op at history start, test input field focus bypass

### Dependencies
Depends on M2-D2.1 (State history manager)

### Verification
1. Add card, press Ctrl+Z → Card removed
2. Move card, press Ctrl+Z → Card returns to original column
3. Advance day, press Ctrl+Z → Day counter decrements, card ages restored
4. Click undo button with no history → Button disabled, no action
5. Run `npm test` → All undo tests pass
